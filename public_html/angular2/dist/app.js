var app=angular.module("app",["ngRoute","ngAlertify"]);app.config(["$httpProvider",function(e){e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]),app.config(["$routeProvider",function(e){e.when("/",{templateUrl:"angular2/src/templates/index.html"}).when("/edit/:id",{title:"Editar",templateUrl:"angular2/src/templates/edit.html",controller:"editController"}).otherwise({redirectTo:"/"})}]),app.directive("jqdatepicker",function(){return{restrict:"A",require:"ngModel",link:function(e,a,t,r){$(a).datepicker({dateFormat:"dd/mm/yy",beforeShow:function(){$(".ui-datepicker").css("font-size",12)},onSelect:function(a){e.$apply(function(){r.$setViewValue(a)})}})}}}),app.directive("jqdatepickerweek",function(){return{restrict:"A",require:"ngModel",link:function(e,a,t,r){var o;$(a).datepicker({showOtherMonths:!0,selectOtherMonths:!0,dateFormat:"dd/mm/yy",beforeShow:function(){$(".ui-datepicker").css("font-size",12)},onSelect:function(a,t){var n=$(this).datepicker("getDate"),i=0!=n.getDay()?7:0;o=new Date(n.getFullYear(),n.getMonth(),n.getDate()-n.getDay()+i);var c=t.settings.dateFormat||$.datepicker._defaults.dateFormat,u=$.datepicker.formatDate(c,o,t.settings);$(this).datepicker("setDate",u),e.$apply(function(){r.$setViewValue(u)})}})}}}),app.directive("showTab",function(){return{link:function(e,a,t){a.on("click",function(e){e.preventDefault(),$(a).tab("show")})}}}),app.directive("toggle",function(){return{restrict:"A",link:function(e,a,t){"tooltip"==t.toggle&&$(a).tooltip(),"popover"==t.toggle&&$(a).popover()}}}),app.directive("capitalize",function(){return{require:"ngModel",link:function(e,a,t,r){var o=function(e){void 0==e&&(e="");var a=e.toUpperCase();return a!==e&&(r.$setViewValue(a),r.$render()),a};r.$parsers.push(o),o(e[t.ngModel])}}}),app.directive("loading",["$http","alertify",function(e,a){return{restrict:"A",link:function(a,t,r){a.isLoading=function(){return e.pendingRequests.length>0},a.$watch(a.isLoading,function(e){e?t.show():t.hide()})}}}]),app.directive("modalShow",["$parse",function(e){return{restrict:"A",link:function(a,t,r){a.showModal=function(e,a){a||(a=t),e?$(a).modal("show"):$(a).modal("hide")},a.$watch(r.modalShow,function(e,t){a.showModal(e,r.$$element)}),$(t).bind("hide.bs.modal",function(){e(r.modalShow).assign(a,!1),a.$$phase||a.$root.$$phase||a.$apply()})}}}]),app.directive("ngConfirmClick",function(){return{link:function(e,a,t){var r=t.ngConfirmClick||"¿Confirmar acción?",o=t.confirmedClick;a.bind("click",function(a){window.confirm(r)&&e.$apply(o)})}}}),app.directive("stringToNumber",function(){return{require:"ngModel",link:function(e,a,t,r){r.$parsers.push(function(e){return""+e}),r.$formatters.push(function(e){return parseFloat(e,2)})}}}),app.controller("appController",["$scope","$http","alertify",function(e,a,t){function r(e,a,t){return e.selected===!0}function o(e,a){return e.length<=1?(t.error("Seleccione dos o más trabajos para "+a),!1):!0}t.logPosition("bottom right"),e.trabajos=[],e.orderByField="km_inicio",e.reverseSort=!1,e.currentPage=0,e.pageTotal=0,e.nextPage=0,e.currentPage=1,e.lastPage=1,e.filtro={page:1,causa:null,trabajo_id:null,km_inicio:null,km_termino:null,grupo_trabajo_id:null,semana:null,vencimiento:null,realizado:!1},a.get("programar",e.filtro).success(function(a){e.trabajos=a.data,e.currentPage=a.current_page,e.lastPage=a.last_page,e.nextPage=a.current_page+1,e.pageTotal=a.total,console.info("trabajos",a.data.length)}),a.get("grupos").success(function(a){e.grupos=a,console.info("grupos",a.length)}),a.get("trabajo").success(function(a){e.partidas=a,console.info("partidas",a.length)}),e.loadMore=function(){e.filtro.page=e.nextPage,a.get("programar",{params:e.filtro}).success(function(a){var t=a.data;t.forEach(function(a){e.trabajos.push(a)}),e.currentPage=a.current_page,e.lastPage=a.last_page,e.nextPage=a.current_page+1,e.pageTotal=a.total,console.info("current_page",a.current_page)})},e.createTrabajo=function(t){a.post("programar",t).success(function(a){a.error?e.errors=a.msg:(e.trabajos.push(a.trabajo),e.errors=[],t.causa="",t.trabajo_id="",t.km_inicio="",t.km_termino="",t.cantidad="")})},e.deleteTrabajo=function(t){confirm("¿Eliminar "+t.nombre+"?")&&a["delete"]("programar/"+t.id).success(function(a){if(!a.error){var r=e.trabajos.indexOf(t);e.trabajos.splice(r,1)}})},e.updateTrabajo=function(e){a.put("programar/"+e.id,e).success(function(a){a.error||(e.status=a.status,e.no_programable&&(e.semana=""))})},e.filtrar=function(){e.filtro.page=1,a.get("programar",{params:e.filtro}).success(function(a){console.info("filtro",e.filtro),e.trabajos=a.data,e.currentPage=a.current_page,e.lastPage=a.last_page,e.nextPage=a.current_page+1,e.pageTotal=a.total})},e.selectAll=function(){var a=!e.isAllSelected;angular.forEach(e.trabajos,function(e){e.selected=a}),e.isAllSelected=a},e.toggleSelection=function(){e.isAllSelected=e.trabajos.every(r)},e.deleteSelected=function(){var t=[];angular.forEach(e.trabajos,function(e){e.selected&&t.push(e)}),o(t,"eliminar")&&t.forEach(function(t){a["delete"]("programar/"+t.id).success(function(a){if(!a.error){var r=e.trabajos.indexOf(t);e.trabajos.splice(r,1)}})})},e.updateSelected=function(t){var r=[];if(angular.forEach(e.trabajos,function(e){e.selected&&r.push(e)}),o(r,"editar")){var n={};t.causa&&(n.causa=t.causa),t.grupo_trabajo_id&&(n.grupo_trabajo_id=t.grupo_trabajo_id),t.semana&&(n.semana=t.semana),t.vencimiento&&(n.vencimiento=t.vencimiento),t.lun&&(n.lun=t.lun),t.mar&&(n.mar=t.mar),t.mie&&(n.mie=t.mie),t.juv&&(n.juv=t.juv),t.vie&&(n.vie=t.vie),t.sab&&(n.sab=t.sab),t.dom&&(n.dom=t.dom);var i={modal:n,trabajos:r};a.post("programar/selected",i).success(function(a){if(!a.error){var t=a.status;angular.forEach(e.trabajos,function(e){e.selected&&(e.selected=!1,t.forEach(function(a){e.id==a.id&&(e.status=a["class"])}),i.modal.causa&&(e.causa=i.modal.causa),i.modal.grupo_trabajo_id&&(e.grupo_trabajo_id=i.modal.grupo_trabajo_id),i.modal.semana&&(e.semana=i.modal.semana),i.modal.vencimiento&&(e.vencimiento=i.modal.vencimiento),i.modal.lun&&(e.lun=i.modal.lun),i.modal.mar&&(e.mar=i.modal.mar),i.modal.mie&&(e.mie=i.modal.mie),i.modal.juv&&(e.juv=i.modal.juv),i.modal.vie&&(e.vie=i.modal.vie),i.modal.sab&&(e.sab=i.modal.sab),i.modal.dom&&(e.dom=i.modal.dom))})}}),t.causa=null,t.grupo_trabajo_id=null,t.semana=null,t.vencimiento=null,t.lun=null,t.mar=null,t.mie=null,t.juv=null,t.vie=null,t.sab=null,t.dom=null}},e.archiveSelected=function(){var t=[];angular.forEach(e.trabajos,function(e){e.selected&&t.push(e)}),o(t,"archivar")&&t.forEach(function(e){e.realizado=!0,e.status="success",a.put("programar/"+e.id,e).success(function(a){a.error||(e.status=a.status)})})},e.mergeSelected=function(){var r=[];angular.forEach(e.trabajos,function(e){e.selected&&r.push(e)}),o(r,"agrupar")&&a.post("programar/merge",{trabajos:r}).success(function(a){a.error?t.error(a.msg):(e.trabajos.push(a.trabajo),e.deleteSelected())})},e.clearSelected=function(){var a=[];angular.forEach(e.trabajos,function(e){e.selected&&a.push(e)}),o(a,"limpiar")&&a.forEach(function(a){a.lun="unchecked",a.mar="unchecked",a.mie="unchecked",a.juv="unchecked",a.vie="unchecked",a.sab="unchecked",a.dom="unchecked",e.updateTrabajo(a)})},e.numberOfPages=function(){return Math.floor(e.trabajos.length/e.pageSize)},e.checkByClick=function(e){e.selected=!e.selected},setInterval(function(){a.get("/programar/connection_status",{timeout:1e4}).then(function(e){"ok"!=e.data&&t.error("Problemas de conexión")},function(e){t.error("Error de conexión"),console.error(e)})},6e4)}]),app.controller("editController",["$scope","$http","$routeParams","$location","alertify",function(e,a,t,r,o){e.textButton="Editar programa trabajo";var n,i,c=e.trabajos.length;for(n=0;c>n&&(i=e.trabajos[n],i.id!=t.id);n++);e.trabajo=i,e.editTrabajo=function(){r.url("/"),a.put("programar/"+e.trabajo.id,e.trabajo).success(function(a){a.error||(e.trabajos[n]=e.trabajo)})}}]);